name: Build and Package

on:
  push:
    branches:
      - edge

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Install AutoHotKey
      run: |
        # Download and install AutoHotKey
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Invoke-WebRequest -Uri 'https://github.com/Lexikos/AutoHotkey_L/releases/download/v2.0-a140-06c64c8/AutoHotkey_2.0-a140-06c64c8.zip' -OutFile 'AutoHotkey.zip'
        Expand-Archive -Path 'AutoHotkey.zip' -DestinationPath $env:ProgramFiles

    - name: Compile Script
      run: |
        # Compile your AutoHotKey script
        & "$env:ProgramFiles\AutoHotkey\Compiler\Ahk2Exe.exe" /in AHKser.ahk /out CompiledScript.exe
      working-directory: ${{ github.workspace }}

    - name: Create ZIP package
      run: |
          # Create the desired ZIP package structure
          mkdir -p AHKser/assets
          mv AHKser.exe AHKser
          mv LICENSE.md AHKser
          mv assets/Scripts AHKser
          mv assets/* AHKser/assets

          # Create the ZIP package
          7z a AHKser.zip AHKser/*
      working-directory: ${{ github.workspace }}

    - name: Release
      run: |
        # Add commands to create a GitHub release with the combined version
        product_version=$(awk -F'"' '/^ProductVersion := "/{print $2}' AHKser.ahk)
        file_version=$(awk -F'"' '/^FileVersion := "/{print $2}' AHKser.ahk)
    
        # Combine ProductVersion and FileVersion into a single version string
        combined_version="$product_version-$file_version"
    
        # Create the GitHub release
        gh release create "$combined_version" AHKser.zip -t "Release $combined_version" -n "Release notes for $combined_version"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      working-directory: ${{ github.workspace }}